name: Update Dependencies

on:
  schedule:
    # Run weekly on Sundays at 2 AM UTC (1 hour before main repo)
    - cron: "0 2 * * 0"
  workflow_dispatch:
    inputs:
      update-type:
        description: "Type of update to perform"
        required: true
        type: choice
        options:
          - "all"
          - "nixpkgs"
          - "nix-darwin"
          - "home-manager"
          - "catppuccin"
          - "ghostty"
          - "nvf-config"
          - "other"
        default: "all"
      create-pr:
        description: "Create a pull request with the updates"
        required: false
        type: boolean
        default: true
      branch-name:
        description: "Branch name to use for the update"
        required: false
        type: string
        default: "update-dependencies"

jobs:
  update-dependencies:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Setup Cachix
        uses: cachix/cachix-action@v16
        with:
          name: nix-community
          skipPush: true

      - name: Cache Nix store
        uses: nix-community/cache-nix-action@v7
        with:
          primary-key: nix-${{ runner.os }}-${{ hashFiles('flake.lock') }}
          restore-prefixes-first-match: nix-${{ runner.os }}-
          gc-max-store-size-linux: 1G

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check for existing PR
        id: check-pr
        run: |
          # Determine base branch from which the workflow was triggered
          # For scheduled runs, use default branch; for workflow_dispatch, use the branch it was triggered from
          BASE_BRANCH="${{ github.ref_name }}"
          # Remove 'refs/heads/' prefix if present
          BASE_BRANCH="${BASE_BRANCH#refs/heads/}"
          echo "Using base branch: $BASE_BRANCH"

          # Construct branch name with base branch suffix
          BASE_BRANCH_NAME="${{ github.event.inputs.branch-name || 'update-dependencies' }}"
          BRANCH_NAME="${BASE_BRANCH_NAME}-${BASE_BRANCH}"
          echo "Using branch name: $BRANCH_NAME"

          # Check for existing open PRs with head branch
          EXISTING_PR=$(gh pr list --base "$BASE_BRANCH" --state open --head "$BRANCH_NAME" --json number --jq '.[0] // empty')

          if [ -n "$EXISTING_PR" ]; then
            PR_NUMBER=$(echo "$EXISTING_PR" | jq -r '.number')
            echo "Found existing PR #$PR_NUMBER on branch $BRANCH_NAME targeting $BASE_BRANCH"
            echo "pr-exists=true" >> $GITHUB_OUTPUT
            echo "pr-number=$PR_NUMBER" >> $GITHUB_OUTPUT
          else
            echo "No existing PR found"
            echo "pr-exists=false" >> $GITHUB_OUTPUT
          fi
          echo "branch-name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "base-branch=$BASE_BRANCH" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare branch
        run: |
          BRANCH_NAME="${{ steps.check-pr.outputs.branch-name }}"
          if [ "${{ steps.check-pr.outputs.pr-exists }}" == "true" ]; then
            echo "Using existing branch: $BRANCH_NAME"
            # Fetch the remote branch if it exists
            git fetch origin $BRANCH_NAME:$BRANCH_NAME 2>/dev/null || true
            # Checkout the branch (create locally if it doesn't exist)
            git checkout $BRANCH_NAME 2>/dev/null || git checkout -b $BRANCH_NAME
          else
            echo "Creating new branch: $BRANCH_NAME"
            git checkout -b $BRANCH_NAME
          fi

      - name: Save base branch lockfile
        run: |
          BASE_BRANCH="${{ steps.check-pr.outputs.base-branch }}"
          git fetch origin "$BASE_BRANCH" --depth=1
          git show "origin/$BASE_BRANCH:flake.lock" > flake.lock.before
          echo "Saved flake.lock from origin/$BASE_BRANCH for diff (all changes vs. target branch)"

      - name: Update dependencies
        id: update
        run: |
          echo "Updating dependencies..."

          case "${{ github.event.inputs.update-type || 'all' }}" in
            "all")
              echo "Updating all dependencies..."
              nix flake update --accept-flake-config
              ;;
            "nixpkgs")
              echo "Updating nixpkgs..."
              nix flake update --update-input nixpkgs --accept-flake-config
              ;;
            "nix-darwin")
              echo "Updating nix-darwin..."
              nix flake update --update-input nix-darwin --accept-flake-config
              ;;
            "home-manager")
              echo "Updating home-manager..."
              nix flake update --update-input home-manager --accept-flake-config
              ;;
            "catppuccin")
              echo "Updating catppuccin themes..."
              nix flake update --update-input catppuccin --update-input catppuccin-vsc --accept-flake-config
              ;;
            "ghostty")
              echo "Updating ghostty..."
              nix flake update --update-input ghostty --accept-flake-config
              ;;
            "nvf-config")
              echo "Updating nvf-config..."
              nix flake update --update-input nvf-config --accept-flake-config
              ;;
            "other")
              echo "Updating other dependencies..."
              nix flake update --accept-flake-config
              ;;
          esac

          # Check if there are any changes
          if git diff --quiet; then
            echo "No changes to dependencies"
            echo "has-changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Changes detected, generating updates list..."

          # Generate old -> new version list for PR body (root inputs only)
          echo "## Updated inputs" > dependency-updates.md
          echo "" >> dependency-updates.md
          jq -rs '
            def short_rev:
              if type == "string" then
                if startswith("http") then "tarball" else (if length > 7 then .[0:7] else . end) end
              else "?" end;
            (.[1].nodes.root.inputs | keys[]) as $name
            | .[0].nodes.root.inputs[$name] as $oldNode
            | .[1].nodes.root.inputs[$name] as $newNode
            | select($oldNode and $newNode)
            | .[0].nodes[$oldNode].locked as $oldLocked
            | .[1].nodes[$newNode].locked as $newLocked
            | ($oldLocked.rev // $oldLocked.url) as $oldRev
            | ($newLocked.rev // $newLocked.url) as $newRev
            | select($oldRev != $newRev)
            | "- **\($name):** \($oldRev | short_rev) → \($newRev | short_rev)"
          ' flake.lock.before flake.lock >> dependency-updates.md

          echo "Committing update..."

          # Add the flake.lock changes
          git add flake.lock
          git commit -m "Update dependencies (${{ github.event.inputs.update-type || 'all' }})"

          # Push the changes
          BRANCH_NAME="${{ steps.check-pr.outputs.branch-name }}"
          git push origin "$BRANCH_NAME"
          echo "has-changes=true" >> $GITHUB_OUTPUT

      - name: No changes detected
        if: steps.update.outputs.has-changes == 'false'
        run: |
          echo "✅ Dependencies are already up to date - no changes needed"

      - name: Test updated dependencies
        if: steps.update.outputs.has-changes == 'true'
        run: |
          echo "Testing updated dependencies..."
          nix flake check --accept-flake-config
          echo "✅ Dependency update validation passed"

      - name: Create Pull Request
        if: ${{ (github.event.inputs.create-pr || 'true') == 'true' && steps.update.outputs.has-changes == 'true' && steps.check-pr.outputs.pr-exists == 'false' }}
        run: |
          BRANCH_NAME="${{ steps.check-pr.outputs.branch-name }}"
          BASE_BRANCH="${{ steps.check-pr.outputs.base-branch }}"

          {
            echo "This PR updates the flake dependencies."
            echo ""
            if [ -s dependency-updates.md ]; then
              cat dependency-updates.md
              echo ""
            fi
            echo "**Testing:**"
            echo "- [x] Dependency validation passed"
            echo "- [ ] Build check workflow passes"
          } > pr-body.md

          PR_URL=$(gh pr create \
            --title "Update dependencies (${{ github.event.inputs.update-type || 'all' }}) → $BASE_BRANCH" \
            --body-file pr-body.md \
            --head "$BRANCH_NAME" \
            --base "$BASE_BRANCH")

          # Extract PR number from URL (format: https://github.com/owner/repo/pull/123)
          PR_NUMBER=$(echo "$PR_URL" | sed -E 's/.*\/pull\/([0-9]+).*/\1/')

          # Set default merge method to squash
          gh api \
            -X PATCH \
            repos/${{ github.repository }}/pulls/$PR_NUMBER \
            -f merge_method=squash
          echo "✅ Created PR #$PR_NUMBER with squash and merge as default"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update existing Pull Request
        if: ${{ (github.event.inputs.create-pr || 'true') == 'true' && steps.update.outputs.has-changes == 'true' && steps.check-pr.outputs.pr-exists == 'true' }}
        run: |
          PR_NUMBER="${{ steps.check-pr.outputs.pr-number }}"
          {
            echo "This PR updates the flake dependencies."
            echo ""
            if [ -s dependency-updates.md ]; then
              cat dependency-updates.md
              echo ""
            fi
            echo "**Testing:**"
            echo "- [x] Dependency validation passed"
            echo "- [ ] Build check workflow passes"
          } > pr-body.md
          gh pr edit "$PR_NUMBER" --body-file pr-body.md
          echo "✅ Updated existing PR #$PR_NUMBER with latest dependency changes"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
